<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>MD5 Хешування</title>
    <link rel="stylesheet" href="static/styles_2.css">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="container">
        <h1>MD5 Хешування</h1>

        <div class="input-section">
            <label for="input-data">Введіть текст для хешування:</label>
            <div class="input-group">
                <input id="input-data" type="text" placeholder="Введіть текст" class="input-field">
                <button id="switch-to-file" class="switch-button">Вибрати файл</button>
            </div>
            <div id="input-error" class="error"></div>
        </div>

        <button id="hash-button" class="action-button">Хешувати</button>

        <div class="result-section">
            <label>Обчислений хеш:</label>
            <div id="calculated-hash" class="result"></div>
        </div>

        <div class="input-section">
            <label for="hash-input">Введіть хеш для перевірки:</label>
            <div class="input-group">
                <input id="hash-input" type="text" placeholder="Введіть хеш (MD5)" class="input-field">
                <button id="switch-to-hash-file" class="switch-button">Вибрати хеш-файл</button>
            </div>
            <div id="hash-error" class="error"></div>
        </div>

        <button id="verify-button" class="action-button">Перевірити</button>

        <div class="result-section">
            <label>Результат перевірки:</label>
            <div id="verification-result" class="result"></div>
        </div>

        <button id="download-button" class="action-button">Завантажити хеш</button>
        <div id="download-error" class="error"></div>
        <div id="download-stat" class="result"></div>
        <br>
        <a href="/" class="back-link">Назад до меню</a>
    </div>

    <script src="/config.js"></script>
    <script>
        let isInputFile = false;
        let isHashFile = false;
        let calculatedHash = '';

        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        function clearError(elementId) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = '';
            errorElement.style.display = 'none';
        }

        function getErrorMessage(errorMessage) {
            const errorMap = {
                "No data file uploaded": "Не завантажено файл даних",
                "Provided MD5 hash is empty": "Наданий MD5 хеш порожній",
                "Invalid MD5 hash format": "Невірний формат MD5 хешу",
                "Error calculating hash": "Помилка обчислення хешу"
            };
            return errorMap[errorMessage] || errorMessage;
        }

        function getTimestamp() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return `${year}${month}${day}_${hours}${minutes}${seconds}`;
        }

        document.getElementById('switch-to-file').addEventListener('click', () => {
            const inputContainer = document.getElementById('input-data').parentElement;
            const currentInput = document.getElementById('input-data');
            const newType = isInputFile ? 'text' : 'file';
            const newInput = document.createElement('input');
            newInput.id = 'input-data';
            newInput.type = newType;
            newInput.className = 'input-field';
            newInput.placeholder = newType === 'text' ? 'Введіть текст' : '';
            inputContainer.replaceChild(newInput, currentInput);
            document.getElementById('switch-to-file').textContent = isInputFile ? 'Вибрати файл' : 'Ввести текст';
            isInputFile = !isInputFile;
            clearError('input-error');
            clearError('hash-error');
            clearError('download-error');
        });

        document.getElementById('switch-to-hash-file').addEventListener('click', () => {
            const hashContainer = document.getElementById('hash-input').parentElement;
            const currentInput = document.getElementById('hash-input');
            const newType = isHashFile ? 'text' : 'file';
            const newInput = document.createElement('input');
            newInput.id = 'hash-input';
            newInput.type = newType;
            newInput.className = 'input-field';
            newInput.placeholder = newType === 'text' ? 'Введіть хеш (MD5)' : '';
            hashContainer.replaceChild(newInput, currentInput);
            document.getElementById('switch-to-hash-file').textContent = isHashFile ? 'Вибрати хеш-файл' : 'Ввести текст';
            isHashFile = !isHashFile;
            clearError('hash-error');
            clearError('input-error');
            clearError('download-error');
        });

        document.getElementById('hash-button').addEventListener('click', async () => {
            clearError('input-error');
            clearError('hash-error');
            clearError('download-error');
            document.getElementById('download-stat').textContent = '';
            document.getElementById('calculated-hash').textContent = '';
            document.getElementById('verification-result').textContent = '';

            const inputData = document.getElementById('input-data');
            let hasError = false;

            if (isInputFile && (!inputData.files || !inputData.files.length)) {
                showError('input-error', 'Виберіть файл для хешування');
                hasError = true;
            }

            if (hasError) return;

            try {
                const timestamp = getTimestamp();
                const formData = new FormData();
                if (!isInputFile) {
                    const text = inputData.value.trim();
                    const encoder = new TextEncoder();
                    const bytes = encoder.encode(text);
                    const blob = new Blob([bytes], { type: 'text/plain' });
                    formData.append('data_file', blob, `input_${timestamp}.txt`);
                } else {
                    formData.append('data_file', inputData.files[0]);
                }

                const response = await fetch(`${CONFIG.API_URL_LAB_2}/hash`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Помилка API');
                }

                const data = await response.json();
                calculatedHash = data.computed_hash;
                document.getElementById('calculated-hash').textContent = calculatedHash;
            } catch (e) {
                const apiError = e.message.includes('detail') ? e.message.split('detail: ')[1] : e.message;
                showError('input-error', `Помилка хешування: ${getErrorMessage(apiError)}`);
            }
        });

        document.getElementById('verify-button').addEventListener('click', async () => {
            clearError('input-error');
            clearError('hash-error');
            clearError('download-error');
            document.getElementById('download-stat').textContent = '';
            // document.getElementById('calculated-hash').textContent = '';
            document.getElementById('verification-result').textContent = '';

            const inputData = document.getElementById('input-data');
            const hashInput = document.getElementById('hash-input');
            let hasError = false;

            if (isInputFile && (!inputData.files || !inputData.files.length)) {
                showError('input-error', 'Виберіть файл для хешування');
                hasError = true;
            }

            if (!isHashFile && !hashInput.value.trim()) {
                showError('hash-error', 'Введіть хеш для перевірки');
                hasError = true;
            } else if (isHashFile && (!hashInput.files || !hashInput.files.length)) {
                showError('hash-error', 'Виберіть хеш-файл для перевірки');
                hasError = true;
            }

            if (hasError) return;

            try {
                const timestamp = getTimestamp();
                const formData = new FormData();
                if (!isInputFile) {
                    const text = inputData.value.trim();
                    const encoder = new TextEncoder();
                    const bytes = encoder.encode(text);
                    const blob = new Blob([bytes], { type: 'text/plain' });
                    formData.append('data_file', blob, `input_${timestamp}.txt`);
                } else {
                    formData.append('data_file', inputData.files[0]);
                }

                let expectedHash;
                if (!isHashFile) {
                    expectedHash = hashInput.value.trim();
                } else {
                    const hashFile = hashInput.files[0];
                    expectedHash = await hashFile.text();
                }
                formData.append('expected_hash', expectedHash.trim());

                const response = await fetch(`${CONFIG.API_URL_LAB_2}/hash`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Помилка API');
                }

                const data = await response.json();
                calculatedHash = data.computed_hash;
                document.getElementById('calculated-hash').textContent = calculatedHash;
                const verificationResult = document.getElementById('verification-result');
                verificationResult.classList.remove('match', 'mismatch');
                if (data.is_valid !== undefined) {
                    if (data.is_valid) {
                        verificationResult.textContent = 'Хеші збігаються';
                        verificationResult.classList.add('match');
                    } else {
                        verificationResult.textContent = 'Хеші не збігаються';
                        verificationResult.classList.add('mismatch');
                    }
                }
            } catch (e) {
                const apiError = e.message.includes('detail') ? e.message.split('detail: ')[1] : e.message;
                showError('hash-error', `Помилка перевірки: ${getErrorMessage(apiError)}`);
            }
        });

        document.getElementById('download-button').addEventListener('click', async () => {
            clearError('download-error');
            calculatedHash = document.getElementById('calculated-hash').textContent;
            if (!calculatedHash) {
                showError('download-error', 'Спочатку згенеруйте хеш!');
                return;
            }
            const timestamp = getTimestamp();
            let filename;
            if (isInputFile && document.getElementById('input-data').files && document.getElementById('input-data').files.length) {
                const originalFileName = document.getElementById('input-data').files[0].name;
                filename = `md5_hash_${originalFileName}_${timestamp}.txt`;
            } else {
                filename = `md5_hash_input_${timestamp}.txt`;
            }
            const content = calculatedHash;

            if (window.showSaveFilePicker) {
                const handle = await window.showSaveFilePicker({
                    suggestedName: filename,
                    types: [{ description: 'Text Files', accept: { 'text/plain': ['.txt'] } }]
                });
                const writable = await handle.createWritable();
                await writable.write(content);
                await writable.close();
                document.getElementById('download-stat').textContent = `Файл ${filename} збережено`;
                return;
            }
            try {
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
                document.getElementById('download-stat').textContent = `Файл ${filename} збережено`;
            } catch (e) {
                showError('download-error', `Помилка завантаження: ${e.message}`);
            }
        });
    </script>
</body>
</html>